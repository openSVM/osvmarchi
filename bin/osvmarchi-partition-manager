#!/bin/bash

# OSVMarchi Disk Partition Manager
# Quick access to disk partitioning tools

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Show available disks
show_disks() {
    log_info "Available disks:"
    lsblk -f
    echo
}

# Show partition tools menu
show_menu() {
    echo "OSVMarchi Disk Partition Manager"
    echo "================================"
    echo
    echo "1) Show disk information (lsblk)"
    echo "2) Launch GParted (GUI partitioner)"
    echo "3) Launch cfdisk (Terminal partitioner)" 
    echo "4) Launch fdisk (Expert mode)"
    echo "5) Start OSVMarchi installer"
    echo "6) Exit"
    echo
}

# Main function
main() {
    while true; do
        clear
        show_disks
        show_menu
        
        read -p "Select an option [1-6]: " choice
        
        case $choice in
            1)
                clear
                log_info "Detailed disk information:"
                lsblk -f
                echo
                read -p "Press Enter to continue..."
                ;;
            2)
                if command -v gparted &>/dev/null; then
                    log_info "Launching GParted..."
                    gparted
                else
                    log_error "GParted not installed. Install with: pacman -S gparted"
                    read -p "Press Enter to continue..."
                fi
                ;;
            3)
                if command -v cfdisk &>/dev/null; then
                    log_info "Select disk for cfdisk:"
                    mapfile -t disks < <(lsblk -dpno NAME | grep -E '/dev/(sd|nvme|vd)[a-z]$')
                    if [[ ${#disks[@]} -eq 0 ]]; then
                        log_error "No disks found"
                        read -p "Press Enter to continue..."
                        continue
                    fi
                    
                    echo "Available disks:"
                    for i in "${!disks[@]}"; do
                        echo "$((i+1))) ${disks[i]}"
                    done
                    
                    read -p "Select disk [1-${#disks[@]}]: " disk_choice
                    if [[ "$disk_choice" =~ ^[0-9]+$ ]] && [[ $disk_choice -ge 1 ]] && [[ $disk_choice -le ${#disks[@]} ]]; then
                        selected_disk="${disks[$((disk_choice-1))]}"
                        cfdisk "$selected_disk"
                    else
                        log_error "Invalid choice"
                        read -p "Press Enter to continue..."
                    fi
                else
                    log_error "cfdisk not installed. Install with: pacman -S util-linux"
                    read -p "Press Enter to continue..."
                fi
                ;;
            4)
                if command -v fdisk &>/dev/null; then
                    log_warning "fdisk is for expert users only!"
                    log_info "Select disk for fdisk:"
                    mapfile -t disks < <(lsblk -dpno NAME | grep -E '/dev/(sd|nvme|vd)[a-z]$')
                    if [[ ${#disks[@]} -eq 0 ]]; then
                        log_error "No disks found"
                        read -p "Press Enter to continue..."
                        continue
                    fi
                    
                    echo "Available disks:"
                    for i in "${!disks[@]}"; do
                        echo "$((i+1))) ${disks[i]}"
                    done
                    
                    read -p "Select disk [1-${#disks[@]}]: " disk_choice
                    if [[ "$disk_choice" =~ ^[0-9]+$ ]] && [[ $disk_choice -ge 1 ]] && [[ $disk_choice -le ${#disks[@]} ]]; then
                        selected_disk="${disks[$((disk_choice-1))]}"
                        fdisk "$selected_disk"
                    else
                        log_error "Invalid choice"
                        read -p "Press Enter to continue..."
                    fi
                else
                    log_error "fdisk not installed. Install with: pacman -S util-linux"
                    read -p "Press Enter to continue..."
                fi
                ;;
            5)
                if command -v osvmarchi-install &>/dev/null; then
                    log_info "Starting OSVMarchi installer..."
                    osvmarchi-install
                    exit 0
                else
                    log_error "OSVMarchi installer not found in PATH"
                    read -p "Press Enter to continue..."
                fi
                ;;
            6)
                log_info "Goodbye!"
                exit 0
                ;;
            *)
                log_error "Invalid choice. Please select 1-6."
                read -p "Press Enter to continue..."
                ;;
        esac
    done
}

# Show help
show_help() {
    cat << EOF
OSVMarchi Disk Partition Manager

This utility provides easy access to disk partitioning tools.

USAGE:
    $0 [OPTIONS]

OPTIONS:
    -h, --help      Show this help message

TOOLS PROVIDED:
    - Disk information display (lsblk)
    - GParted GUI partitioner
    - cfdisk terminal partitioner  
    - fdisk expert mode partitioner
    - OSVMarchi system installer

EXAMPLES:
    $0              # Start interactive partition manager
    $0 --help       # Show this help

EOF
}

# Parse arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    "")
        main
        ;;
    *)
        log_error "Unknown option: $1"
        echo "Use '$0 --help' for usage information"
        exit 1
        ;;
esac